<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deep Purple vol.2 Event Leaderboard</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  margin: 0;
  font-family: 'Nunito Sans', sans-serif;
  background: #1d2739;
  color: #91a0b5;
  text-align: center;
}
.container { padding: 20px; max-width: 1000px; margin: 0 auto; }
.top-info { background: #312957; padding: 10px; margin-bottom: 15px; font-size: 14px; color: #bf83fb; }
.top-info .bullet { display:inline-block; width:6px; height:6px; background:#bf83fb; border-radius:50%; margin-right:6px; animation:pulse 1.5s infinite; }
.top-info a { color:#bf83fb; text-decoration:underline; margin-left:6px; }
@keyframes pulse { 0%{opacity:1} 50%{opacity:.4} 100%{opacity:1} }
.event-title { font-size:28px; color:#b587fb; margin:10px 0; }
.event-subtitle { font-size:16px; color:#cbd5e1; }
.prize-pool { font-size:24px; font-weight:bold; color:#facc14; margin:15px 0; }
.event-details { font-size:14px; color:#cad4e0; margin-bottom:8px; }
.event-details svg { width:16px; height:16px; stroke:#94a3b8; fill:none; stroke-width:2; vertical-align:middle; margin:0 4px; }
.disclaimer { font-size:12px; color:#cbd5e1; opacity:.7; margin-bottom:20px; }
.scoring-panel { background:#1d273a; border:1px solid #94a3b8; padding:15px; margin:20px auto; width:70%; font-size:12px; }
.scoring-panel .section-title { color:#d8b3fe; font-weight:bold; margin-bottom:10px; }
.scoring-panel .item { margin:4px 0; }
.scoring-panel .legendary { color:#fb923c; }
.previous-panel { background:#22564f; border:1px solid #269759; padding:15px; margin:20px auto; width:70%; }
.previous-panel .title { color:#49de80; font-weight:bold; }
.previous-panel .pulse-dot { display:inline-block; width:6px; height:6px; background:#49de80; border-radius:50%; margin:0 6px; animation:pulse 1.5s infinite; }
.status-button { display:inline-block; margin-top:10px; background:#16a349; color:#fff; padding:8px 12px; border-radius:5px; text-decoration:none; transition:transform .2s; }
.status-button:hover { transform:scale(1.05); }
.search-box { margin:20px auto; position:relative; width:320px; }
.search-box input { width:100%; padding:10px 12px 10px 36px; border-radius:6px; border:1px solid #94a3b8; background:#1d2739; color:#94a3b8; }
.search-box input::placeholder { color:#94a3b8; }
.search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); width:16px; height:16px; }
.search-icon circle, .search-icon line { stroke:#94a3b8; stroke-width:2; fill:none; }
.last-updated { color:#94a3b8; font-size:12px; margin:10px 0 20px 0; }
.last-updated svg { width:14px; height:14px; stroke:#94a3b8; stroke-width:2; fill:none; vertical-align:middle; margin-right:4px; }
.leaderboard-title { background:#8239ed; color:#fff; padding:10px; font-size:20px; margin-bottom:10px; }
.table-container { max-height:400px; overflow-y:auto; margin:auto; width:90%; }
table { border-collapse:collapse; width:100%; font-size:13px; }
thead th { position:sticky; top:0; background:#2c394c; color:#dfe5ee; padding:8px; }
tbody td { padding:8px; border-bottom:1px solid #2a3447; }
tbody tr:hover { background:#2c394c; }
tbody tr:nth-child(1) { background:#413e2f; color:#fff; font-weight:bold; }
tbody tr:nth-child(2) { background:#313e51; color:#fff; font-weight:bold; }
tbody tr:nth-child(3) { background:#473431; color:#fff; font-weight:bold; }
.stats { display:flex; justify-content:center; gap:20px; margin-top:20px; }
.stat-box { flex:1; padding:10px; }
.stat-box div:first-child { font-size:28px; font-weight:bold; }
.small-hint { font-size:12px; opacity:.8; margin-top:6px; }
.download { display:inline-block; margin:10px 0; color:#bf83fb; text-decoration:underline; }
.error { color:#ffb4b4; }
</style>
</head>
<body>
<div class="container">

<!-- Top info -->
<div class="top-info">
  <span class="bullet"></span>Gold and heroes must be acquired during the event to be counted.
  <a href="https://game.sleepagotchi.com/">Play now</a>
</div>

<div class="event-title">Deep Purple vol.2</div>
<div class="event-subtitle">Sleepagotchi x PIXELS Collaboration</div>
<div class="prize-pool">Prize Pool: 500 000 PIXELS (≈ 17 000 USD)</div>
<div class="event-details">
  <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
  September 22, 4pm UTC - September 26, 4pm UTC
  <svg viewBox="0 0 24 24"><path d="M6 3h12v2a6 6 0 0 1-6 6 6 6 0 0 1-6-6V3z"/><rect x="9" y="11" width="6" height="10"/></svg>
  Top 1,000 Players
</div>
<div class="disclaimer">
  Prizes are paid in $PIXEL to Ronin addresses. USD values are for reference only, based on a rate of $0.031 per $PIXEL. Actual value may vary due to token price volatility.
</div>

<!-- Scoring -->
<div class="scoring-panel">
  <div class="section-title">Scoring System</div>
  <div class="item">Collect Purple Moon Stones to climb the leaderboard</div>
  <div class="item">Boost your rewards with Legendary Card multipliers from the Gacha in Sleepagotchi LITE</div>
  <div class="item legendary">Legendary Card - 10 %</div>
</div>

<!-- Search -->
<div class="search-box">
  <svg class="search-icon" viewBox="0 0 24 24">
    <circle cx="11" cy="11" r="8"/><line x1="17" y1="17" x2="22" y2="22"/>
  </svg>
  <input type="text" placeholder="Find yourself or a friend..." id="searchInput">
</div>

<!-- Last updated -->
<div class="last-updated" id="lastUpdated">
  <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="6" x2="12" y2="12"/><line x1="12" y1="12" x2="16" y2="14"/></svg>
  Last Updated: —
</div>

<!-- Leaderboard -->
<div class="leaderboard-title">LEADERBOARD</div>
<div class="table-container">
  <table id="leaderboard">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Username</th>
        <th>Score</th>
        <th>Purple</th>
        <th>Legendary</th>
        <th>PIXEL</th>
        <th>USD (ref.)</th>
      </tr>
    </thead>
    <tbody id="tbody"><tr><td colspan="7">Loading…</td></tr></tbody>
  </table>
</div>

<!-- Bottom stats -->
<div class="stats">
  <div class="stat-box" style="background:#1f423e;color:#baf7d0;">
    <div style="color:#fff;" id="qualifyingCount">–</div>
    <div>Qualifying Players</div>
  </div>
  <div class="stat-box" style="background:#403533;color:#e4d57d;">
    <div style="color:#fff;">500,000</div>
    <div>Total PIXEL Pool</div>
  </div>
  <div class="stat-box" style="background:#2b2656;color:#c2b2dd;">
    <div style="color:#fff;">$17,000</div>
    <div>Total USD Pool</div>
  </div>
</div>

<script>
// --- Helpers ---
function detectDelimiter(firstLine){
  const candidates = [',','\t',';'];
  const counts = {',':0,'\t':0,';':0};
  let q=false;
  for (let i=0;i<firstLine.length;i++){
    const ch = firstLine[i], nx = firstLine[i+1];
    if (ch === '"'){ if (q && nx === '"'){ i++; } else { q=!q; } }
    else if (!q && counts.hasOwnProperty(ch)) counts[ch]++;
  }
  let best = ',', max=-1;
  for (const c of candidates){ if (counts[c]>max){ max=counts[c]; best=c; } }
  return best;
}
function parseCSV(text){
  const content = text.replace(/\r/g,'').trim();
  if (!content) return [];
  const lines = content.split('\n');
  const delim = detectDelimiter(lines[0]);
  const rows = lines.map(line=>{
    const out=[], n=line.length; let cur='', q=false;
    for (let i=0;i<n;i++){
      const ch=line[i], nx=line[i+1];
      if (ch === '"'){
        if (q && nx === '"'){ cur+='"'; i++; }
        else { q=!q; }
      } else if (ch === delim && !q){ out.push(cur); cur=''; }
      else { cur += ch; }
    }
    out.push(cur);
    return out;
  });
  return rows;
}
function toNumber(x){ const n=Number(String(x??'').replace(/\s|,/g,'')); return isNaN(n)?0:n; }
function fmtInt(n){ return Number(n||0).toLocaleString('en-US'); }
function fmtUSD(n){ return '$' + Number(n||0).toLocaleString('en-US', { maximumFractionDigits: 2 }); }
function timeAgo(fromMs){
  const now = Date.now();
  const diff = Math.max(0, now - fromMs);
  const s = Math.floor(diff/1000);
  if (s < 60) return `${s} sec ago`;
  const m = Math.floor(s/60);
  if (m < 60) return `${m} min ago`;
  const h = Math.floor(m/60);
  if (h < 24) return `${h} h ago`;
  const d = Math.floor(h/24);
  if (d < 30) return `${d} d ago`;
  const mo = Math.floor(d/30);
  if (mo < 12) return `${mo} mo ago`;
  const y = Math.floor(mo/12);
  return `${y} y ago`;
}
function escapeHTML(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

// --- Loaders ---
async function loadCSV(path){
  const res = await fetch(path, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status} for ${path}`);
  return { text: await res.text(), headers: res.headers };
}
async function loadPixelMap(){
  try{
    const { text } = await loadCSV('./pixel.csv');
    const rows = parseCSV(text);
    if (!rows.length) return {};
    const headers = rows[0].map(h=>String(h).trim().toLowerCase());
    const idx = Object.fromEntries(headers.map((h,i)=>[h, i]));
    if (!('rank' in idx && 'pixel' in idx && 'usd' in idx)) return {};
    const map = {};
    for (let i=1;i<rows.length;i++){
      const r = rows[i];
      const rank = toNumber(r[idx['rank']]);
      const px = toNumber(r[idx['pixel']]);
      const usd = toNumber(r[idx['usd']]);
      if (rank>0) map[rank] = { pixel: px, usd: usd };
    }
    return map;
  }catch(_){
    return {};
  }
}

// --- Load CSV and render ---
(async function(){
  const lastEl = document.getElementById('lastUpdated');
  const tbody = document.getElementById('tbody');
  const qualifyingEl = document.getElementById('qualifyingCount');

  let lastModifiedMs = null;

  try{
    // Last-Modified
    const head = await fetch('./result1_data.csv', { method: 'HEAD', cache: 'no-store' }).catch(()=>null);
    if (head && head.ok){
      const lm = head.headers.get('last-modified');
      if (lm){
        const d = new Date(lm);
        if (!isNaN(d)) lastModifiedMs = d.getTime();
      }
    }

    // Загружаем leaderboard и призы
    const [{ text: csvText, headers }, rewards] = await Promise.all([
      loadCSV('./result_data.csv'),
      loadPixelMap()
    ]);

    if (!lastModifiedMs){
      const lm2 = headers.get('last-modified');
      if (lm2){
        const d2 = new Date(lm2);
        if (!isNaN(d2)) lastModifiedMs = d2.getTime();
      }
    }

    // Парсим result_data.csv
    const rows = parseCSV(csvText);
    if (!rows.length) throw new Error('CSV is empty');

    const headersRow = rows[0].map(h => String(h).trim());
    const idx = Object.fromEntries(headersRow.map((h,i)=>[h.toLowerCase(), i]));
    const has = (name) => Object.prototype.hasOwnProperty.call(idx, name);
    const gi = (row, name) => row[idx[name]];

    let data = rows.slice(1).map(r=>{
      const score = has('score') ? toNumber(gi(r,'score')) : 0;
      const purple = has('purple') ? toNumber(gi(r,'purple')) : 0;
      const legendaries = has('legendaries') ? toNumber(gi(r,'legendaries')) : 0;
      return {
        username: has('username') ? gi(r,'username') : '',
        score,
        purple,
        legendaries
      };
    });

    // Сортировка: score → purple → legendaries → username
    data.sort((a,b)=>
      b.score - a.score ||
      b.purple - a.purple ||
      b.legendaries - a.legendaries ||
      String(a.username).localeCompare(String(b.username))
    );

    // TOP-3000 и ранжирование
    data = data.slice(0, 3000);
    data.forEach((row, i)=> row.rank = i+1);

    // Рендер
    const frag = document.createDocumentFragment();
    for (const row of data){
      const prize = (row.rank <= 1000 && rewards[row.rank])
        ? rewards[row.rank]
        : { pixel: 0, usd: 0 };

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.rank}</td>
        <td>${escapeHTML(row.username)}</td>
        <td>${fmtInt(row.score)}</td>
        <td>${fmtInt(row.purple)}</td>
        <td>${fmtInt(row.legendaries)}</td>
        <td>${fmtInt(prize.pixel)}</td>
        <td>${fmtUSD(prize.usd)}</td>
      `;
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);

    qualifyingEl.textContent = fmtInt(data.length);

    // Last Updated
    const ts = lastModifiedMs ?? Date.now();
    const rel = timeAgo(ts);
    const icon = '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="6" x2="12" y2="12"/><line x1="12" y1="12" x2="16" y2="14"/></svg>';
    lastEl.innerHTML = `${icon} Last Updated: ${rel}`;
    setInterval(()=>{
      const relNow = timeAgo(ts);
      lastEl.innerHTML = `${icon} Last Updated: ${relNow}`;
    }, 60_000);

  } catch(e){
    console.error(e);
    const icon = '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="6" x2="12" y2="12"/><line x1="12" y1="12" x2="16" y2="14"/></svg>';
    lastEl.innerHTML = `${icon} Last Updated: —`;
  }

  // Search by username
  const input = document.getElementById('searchInput');
  input.addEventListener('input', function() {
    const filter = input.value.toUpperCase();
    const trs = document.getElementById('leaderboard').getElementsByTagName('tr');
    for (let i = 1; i < trs.length; i++) {
      const td = trs[i].getElementsByTagName('td')[1];
      if (td) {
        const txtValue = td.textContent || td.innerText;
        trs[i].style.display = txtValue.toUpperCase().includes(filter) ? '' : 'none';
      }
    }
  });
})();
</script>
</div>
</body>
</html>
